~ slide_dbl(lag(.x, 1), mean, .before = 2, .complete = TRUE, na.rm = TRUE),
.names = "{.col}_avg3"
)
)
(3504+3642+3682)/3
(3504+3642+3682)/3
alldata_lagged <- alldata %>%
arrange(team, season) %>%
select(team, season, cf, ca)%>%
group_by(team) %>%
mutate(across(all_of(c("cf", "ca")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(
all_of(c("cf", "ca")),
~ slide_dbl(lag(.x, 1), mean, .before = 2, .complete = TRUE, na.rm = FALSE),
.names = "{.col}_avg3"
)
)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
select(team, season, cf, ca)%>%
group_by(team) %>%
mutate(across(all_of(c("cf", "ca")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(
all_of(c("cf", "ca")),
~ slide_dbl(lag(.x, 1), mean, .before = 2, .complete = TRUE, na.rm = FALSE),
.names = "{.col}_avg3"
),
across(all_of(c("cf", "ca")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_aavg3")
)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%
select(-X) %>%
clean_names()
lag1vars <- c(everything(), -team, -season)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(all_of(-c(team, season),~ lag(.x, 1),.names = "{.col}_lag1")
)
)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(all_of(-c(team, season),~ lag(.x, 1),.names = "{.col}_lag1")))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(all_of(-c(team, season)),~ lag(.x, 1),.names = "{.col}_lag1"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(all_of(-c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(all_of(c(everything(), -team, -season)),~ lag(.x, 1),.names = "{.col}_lag1"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(
-c(team, season),
~ lag(.x, 1),
.names = "{.col}_lag1"
)
)
names(alldata)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(
-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"
)
)
View(alldata_lagged)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%
select(-X) %>%
clean_names() %>%
mutate(winperc = w/gp)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
)
View(alldata_lagged)
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,win_pct,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season", matches("_lag1$")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season", matches("_lag1$"))), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season", matches("_lag1"))), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-c(team, season), ~ lag(.x, 1), .names = "{.col}_lag1"),
across(-c(team, season), ~ (lag(.x, 1) + lag(.x, 2) + lag(.x, 3)) / 3, .names = "{.col}_avg3")
) %>%
ungroup() %>%
select(team, season, winperc, matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season", ends_with("_lag1"))), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(across(-any_of(c("team", "season")),~ lag(.x, 1),.names = "{.col}_lag1"),
across(-any_of(c("team", "season" ), ends_with("_lag1")), ~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3, .names = "{.col}_avg3")
) %>%  select(team,season,winperc,matches("_lag1$|_avg3$"))
alldata_lagged <- alldata %>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$"))
View(alldata_lagged)
train_data <- alldata_lagged %>%
filter(season < 2425)
test_data <- alldata_lagged %>%
filter(season == 2425) %>%
select(-winperc)
View(test_data)
View(train_data)
lm(winperc ~ winperc_lag1 + winperc_avg3, data = train_data)
predict.lm(lm(winperc ~ winperc_lag1 + winperc_avg3, data = train_data)
)
train_data$pwinperc <- predict.lm(lm(winperc ~ winperc_lag1 + winperc_avg3, data = train_data))
train_data <- alldata_lagged %>%
filter(season < 2425, is.na(scgf_avg3) == FALSE)
train_data$pwinperc <- predict.lm(lm(winperc ~ winperc_lag1 + winperc_avg3, data = train_data))
x <-train_data(team, season, winperc, pwinperc)
x <-train_data%>%select(team, season, winperc, pwinperc)
View(x)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%
select(-X) %>%
clean_names() %>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
View(alldata)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%
select(-X) %>%
clean_names() %>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
train <- alldata_lagged %>%
filter(season < 2425)
test <- alldata_lagged %>%
filter(season == 2425) %>%
select(-winperc)
View(train)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%
select(-X)
View(alldata)
names(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x, check.names = FALSE) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>%select(-X)
alldata <- map_dfr(files, ~ {
read.csv(.x, check.names = FALSE) %>%         # <-- key change
rename_with(~ str_replace_all(.x, "%", "p")) %>%  # CF% -> CFp, Point % -> Point p
rename_with(~ str_replace_all(.x, " ", "_")) %>%  # Point_p (after space-> _)
mutate(season = str_extract(.x, "\\d{4}"))
})
alldata <- map_dfr(files, ~ {
read.csv(.x, check.names = FALSE) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names()
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names()
View(alldata)
names(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "p", .x),
ends_with("_2")
)
View(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)
names(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
View(train)
library(tidyverse)
library(janitor)
library(slider)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
View(train)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
View(train)
write_csv2(train, "train.csv")
write_csv2(test, "test.csv")
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
write.csv(train, "train.csv")
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1, winperc_avg3)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
eval<- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(eval, "eval.csv")
install.packages("haven")
library(haven)
write_dta(train, "train.dta")
write_dta(eval, "eval.dta")
