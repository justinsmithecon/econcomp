mutate(season = str_extract(.x, "\\d{4}"))
})
alldata <- map_dfr(files, ~ {
read.csv(.x, check.names = FALSE) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names()
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names()
View(alldata)
names(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "p", .x),
ends_with("_2")
)
View(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)
names(alldata)
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
View(train)
library(tidyverse)
library(janitor)
library(slider)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
View(train)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1)
train <- alldata %>%
filter(season < 2425)
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
View(train)
write_csv2(train, "train.csv")
write_csv2(test, "test.csv")
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
write.csv(train, "train.csv")
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1, winperc_avg3)
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
test <- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(test, "test.csv")
train <- alldata %>%
filter(season < 2425)
write_csv(train, "train.csv")
eval<- alldata %>%
filter(season == 2425) %>%
select(-winperc)
write_csv(eval, "eval.csv")
install.packages("haven")
library(haven)
write_dta(train, "train.dta")
write_dta(eval, "eval.dta")
library(tidyverse)
library(janitor)
library(slider)
library(haven)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1, winperc_avg3)
setwd("~/Desktop/hockeydata")
library(tidyverse)
library(janitor)
library(slider)
library(haven)
files <- list.files(pattern = "^hockey.*\\.csv$")
alldata <- map_dfr(files, ~ {
read.csv(.x) %>%
mutate(
season = str_extract(.x, "\\d{4}")
)
}) %>% select(-X) %>%
clean_names() %>%
rename(point_p = point) %>%
rename_with(
~ sub("_2$", "_p", .x),
ends_with("_2")
)%>%
mutate(winperc = w/gp)%>%
arrange(team, season) %>%
group_by(team) %>%
mutate(
across(-any_of(c("team", "season")),
~ lag(.x, 1),
.names = "{.col}_lag1"),
across(-any_of(c("team", "season")) & !ends_with("_lag1"),
~ (lag(.x, 3) + lag(.x, 2) + lag(.x, 1))/3,
.names = "{.col}_avg3")
) %>%
select(team, season, winperc, matches("_lag1$|_avg3$")) %>%
filter(is.na(scgf_avg3) == FALSE) %>%
relocate(team, season, winperc, winperc_lag1, winperc_avg3)
evaloutcome<- alldata %>%
filter(season == 2425) %>%
select(team, winperc)
View(evaloutcome)
write_csv(evaloutcome, "evaloutcome.csv")
setwd("~/OneDrive - Wilfrid Laurier University/Administrative/UG Chair/econcomp")
library(tidyverse)
library(Metrics)
library(readxl)
library(writexl)
library(gt)
library(googledrive)
library(magrittr)
teamlist <- read_xlsx("data/teams.xlsx")
View(teamlist)
drive_deauth()
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|"))) %>%
rowwise() %>%
mutate(time = drive_resource$createdTime, gname = word(name,1, sep = "[ .]")) %>%
group_by(gname) %>%
slice_max(time) %>%
ungroup() %>%
select(name, id, time)
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe")
View(drivefiles)
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|")))
teamlist <- read_xlsx("data/teams.xlsx")
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|")))
View(drivefiles)
drive_deauth()
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|"))) %>%
rowwise() %>%
mutate(time = drive_resource$createdTime, gname = word(name,1, sep = "[ .]")) %>%
group_by(gname) %>%
slice_max(time) %>%
ungroup() %>%
select(name, id, time)
for (file_id in drivefiles$id) {
drive_download(as_id(file_id), overwrite = TRUE)
}
View(drivefiles)
filenames <- drivefiles %>% pull(name)
evaloutcome<-drive_read_string("/Users/jsmith/Desktop/hockeydata/evaloutcome.csv")%>% read.csv(text=.)
evaloutcome<-drive_read_string("Users/jsmith/Desktop/hockeydata/evaloutcome.csv")%>% read.csv(text=.)
evaloutcome<-drive_read_string("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe")%>% read.csv(text=.)
evaloutcome<-drive_read_string("https://drive.google.com/file/d/176Q-Sf-VpPqglHMOfXszjlTQTBgQDyYY/view?usp=sharing")%>% read.csv(text=.)
View(evaloutcome)
lboard <- function(x){
groupname <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(longname) %>% unlist(use.names = FALSE)
year <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(year) %>% unlist(use.names = FALSE)
submittime <- drivefiles %>% filter(name==x) %>% pull(time) %>% strptime(format = "%Y-%m-%dT%H:%M:%OSZ")
data <- read_csv(x) %>% full_join(.,evaloutcome, by="team")
row <- c(groupname, format(submittime, format = "%d-%m-%Y"), rmse(data$winperc, data$pwinperc), year)
return(row)
}
x<-lapply(filenames, lboard) %>%
{as.data.frame(do.call(rbind, .))} %>%
mutate(across(c(V3), as.numeric)) %>%
arrange(V3)
View(x)
x %>% mutate(Rank = row_number()) %>%
gt() %>%
tab_header(title = "Overall Leader Board") %>%
cols_label(
V1 = "Group Name",
V2 = "Latest Submission",
V3 = "RMSE",
V4 = "Year"
) %>%
cols_align(
V1:V4,
align = "center"
) %>%
cols_move_to_start(columns = Rank)
x %>% arrange(V4, V3) %>%
mutate(V4 = if_else(V4 != "MABE", paste0("Year ", V4), V4)) %>%
group_by(V4) %>%
mutate(Rank = row_number()) %>% ungroup() %>%
gt(groupname_col = "V4") %>%
tab_header(title = "Leader Board by Year") %>%
cols_label(
V1 = "Group Name",
V2 = "Latest Submission",
V3 = "RMSE",
V4 = "Year"
) %>%
cols_align(
V1:V4,
align = "center"
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_row_groups()
) %>%
cols_move_to_start(columns = Rank)
unlink("*.csv")
library(tidyverse)
library(Metrics)
library(readxl)
library(writexl)
library(gt)
library(googledrive)
library(magrittr)
teamlist <- read_xlsx("data/teams.xlsx")
#DATA_FOLDER <- Sys.getenv("DATA_FOLDER")
drive_deauth()
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|"))) %>%
rowwise() %>%
mutate(time = drive_resource$createdTime, gname = word(name,1, sep = "[ .]")) %>%
group_by(gname) %>%
slice_max(time) %>%
ungroup() %>%
select(name, id, time)
for (file_id in drivefiles$id) {
drive_download(as_id(file_id), overwrite = TRUE)
}
filenames <- drivefiles %>% pull(name)
View(teamlist)
View(drivefiles)
#EVAL_FILE = Sys.getenv("EVAL_FILE")
evaloutcome<-drive_read_string("https://drive.google.com/file/d/176Q-Sf-VpPqglHMOfXszjlTQTBgQDyYY/view?usp=sharing")%>% read.csv(text=.)
View(evaloutcome)
lboard <- function(x){
groupname <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(longname) %>% unlist(use.names = FALSE)
year <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(year) %>% unlist(use.names = FALSE)
submittime <- drivefiles %>% filter(name==x) %>% pull(time) %>% strptime(format = "%Y-%m-%dT%H:%M:%OSZ")
data <- read_csv(x) %>% full_join(.,evaloutcome, by="team")
row <- c(groupname, format(submittime, format = "%d-%m-%Y"), rmse(data$winperc, data$pwinperc), year)
return(row)
}
x<-lapply(filenames, lboard) %>%
{as.data.frame(do.call(rbind, .))} %>%
mutate(across(c(V3), as.numeric)) %>%
arrange(V3)
View(x)
x<-lapply(filenames, lboard)
groupname <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|")))
groupname <- filter(teamlist, str_detect(shortname, paste(word(filename,1, sep = "[ .]"), collapse="|")))
groupname <- filter(teamlist, str_detect(shortname, paste(word(filenames,1, sep = "[ .]"), collapse="|")))
View(groupname)
filenames
library(tidyverse)
library(Metrics)
library(readxl)
library(writexl)
library(gt)
library(googledrive)
library(magrittr)
teamlist <- read_xlsx("data/teams.xlsx")
#DATA_FOLDER <- Sys.getenv("DATA_FOLDER")
drive_deauth()
drivefiles <- drive_ls("https://drive.google.com/drive/u/1/folders/135d8aSRH2uNJIxjGp4xJlBHL_8tINpvCp_9gO0fe1KctNJJTqobTG8UsHlHSo6vb4i-O-FHe") %>%
filter(str_detect(name, paste(teamlist$shortname, collapse="|"))) %>%
rowwise() %>%
mutate(time = drive_resource$createdTime, gname = word(name,1, sep = "[ .]")) %>%
group_by(gname) %>%
slice_max(time) %>%
ungroup() %>%
select(name, id, time)
for (file_id in drivefiles$id) {
drive_download(as_id(file_id), overwrite = TRUE)
}
filenames <- drivefiles %>% pull(name)
#EVAL_FILE = Sys.getenv("EVAL_FILE")
evaloutcome<-drive_read_string("https://drive.google.com/file/d/176Q-Sf-VpPqglHMOfXszjlTQTBgQDyYY/view?usp=sharing")%>% read.csv(text=.)
lboard <- function(x){
groupname <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(longname) %>% unlist(use.names = FALSE)
year <- filter(teamlist, str_detect(shortname, paste(word(x,1, sep = "[ .]"), collapse="|"))) %>% select(year) %>% unlist(use.names = FALSE)
submittime <- drivefiles %>% filter(name==x) %>% pull(time) %>% strptime(format = "%Y-%m-%dT%H:%M:%OSZ")
data <- read_csv(x) %>% full_join(.,evaloutcome, by="team")
row <- c(groupname, format(submittime, format = "%d-%m-%Y"), rmse(data$winperc, data$pwinperc), year)
return(row)
}%>% select(longname) %>% unlist(use.names = FALSE)
x<-lapply(filenames, lboard) %>%
{as.data.frame(do.call(rbind, .))} %>%
mutate(across(c(V3), as.numeric)) %>%
arrange(V3)
View(x)
View(evaloutcome)
zz<-drive_read_string("https://drive.google.com/file/d/15RuOIde0fRz0SaNIYmo_4izfO5m4DudF/view?usp=sharing")%>% read.csv(text=.)
aa <- left_join(evaloutcome, zz, by= by="team")
aa <- left_join(evaloutcome, zz, by= "team")
View(aa)
rmse(evaloutcome$winperc, zz$pwinperc)
aa <- full_join(evaloutcome, zz, by= "team")
View(aa)
